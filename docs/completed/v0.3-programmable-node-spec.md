# buhdi-node v0.3 â€” Programmable Node (Cloud Buhdi Self-Programming)

**Status:** Draft  
**Author:** Buhdi  
**Date:** 2026-02-20  
**Depends on:** v0.2 (service mode, auto-reconnect, crash recovery)  
**This is the moat.**

---

## Executive Summary

v0.2 makes buhdi-node reliable. v0.3 makes it **alive**.

Cloud Buhdi can programmatically write, deploy, update, and manage custom tools on each user's buhdi-node. Every node becomes unique â€” shaped by the AI to fit that specific business. After 6 months, a bakery's node and a law firm's node share almost no code besides the core runtime.

This is not "AI that uses tools." This is **AI that builds its own tools for each job.**

---

## Why This Is The Moat

1. **Switching cost is astronomical** â€” the AI built your infrastructure  
2. **Value compounds over time** â€” longer use = more customized  
3. **No competitor can replicate it** â€” even copying the platform can't copy 6 months of per-business evolution  
4. **Each node teaches Cloud Buhdi** â€” patterns from one bakery improve what it builds for the next  
5. **Zero developer needed** â€” small businesses get custom software without hiring anyone

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        mybuhdi.com (Cloud)                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Cloud Buhdi â”‚  â”‚ Tool Registryâ”‚  â”‚  Deploy Pipeline       â”‚ â”‚
â”‚  â”‚  (AI Brain)  â”‚â”€â”€â”‚  (Supabase)  â”‚â”€â”€â”‚  write â†’ test â†’ audit  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  â†’ sign â†’ push â†’ verify â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                          â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ WebSocket (wss://)                       â”‚
          â”‚ Commands + Code Bundles                  â”‚
          â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User's Machine (buhdi-node)                   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Plugin Runtime                         â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ Square   â”‚  â”‚ Inventoryâ”‚  â”‚ Email    â”‚  ...per-biz    â”‚   â”‚
â”‚  â”‚  â”‚ POS Sync â”‚  â”‚ Tracker  â”‚  â”‚ Watcher  â”‚  custom tools  â”‚   â”‚
â”‚  â”‚  â”‚ (sandbox)â”‚  â”‚ (sandbox)â”‚  â”‚ (sandbox)â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Plugin Manager     â”‚  â”‚  Local Dashboard Server   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  install/update/    â”‚  â”‚  :3847 (per-biz UI)       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  rollback/uninstall â”‚  â”‚  Built by Cloud Buhdi     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Vault      â”‚  â”‚ Audit Log   â”‚  â”‚ Permission Enforcer    â”‚   â”‚
â”‚  â”‚ (secrets)  â”‚  â”‚ (every op)  â”‚  â”‚ (sandbox boundaries)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Trust Levels (Pre-existing in mybuhdi.com)

Already built into the backend settings. v0.3 links them to the node.

| Level | Name | Behavior |
|-------|------|----------|
| ğŸ”’ | **Approve Each** | Every tool deploy shows in dashboard, user clicks Approve/Reject |
| âœ… | **Approve New Only** | Updates to existing tools auto-deploy. New tools need approval |
| ğŸ¦š | **Peacock Mode** | "Let me fly, captain." Full autonomy. Cloud Buhdi deploys freely |

Trust level is per-node (a user might trust their office node more than their home laptop).

---

## 1. Plugin Architecture

### 1.1 Plugin Manifest

Every tool is a self-contained plugin with a manifest:

```json
{
  "name": "square-pos-sync",
  "version": "1.2.0",
  "description": "Syncs Square POS transactions to local inventory tracker",
  "author": "cloud-buhdi",
  "created": "2026-03-15T10:00:00Z",
  "updated": "2026-03-18T14:30:00Z",
  
  "runtime": "node",
  "entry": "index.js",
  "schedule": "*/15 * * * *",
  
  "permissions": {
    "network": ["connect.squareup.com", "api.squareup.com"],
    "filesystem": ["read:./data", "write:./data"],
    "env": ["SQUARE_ACCESS_TOKEN"],
    "system": []
  },
  
  "resources": {
    "maxMemoryMb": 128,
    "maxCpuPercent": 25,
    "timeoutMs": 30000,
    "maxDiskMb": 50
  },
  
  "config": {
    "location_id": { "type": "string", "required": true },
    "sync_interval_min": { "type": "number", "default": 15 }
  },
  
  "dependencies": ["node-fetch@3"],
  "codeHash": "sha256:abc123...",
  "signature": "cloud-buhdi:ed25519:xyz..."
}
```

### 1.2 Plugin Lifecycle

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ PENDING  â”‚ (awaiting user approval)
         â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚ approve
         â”‚               â–¼
         â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   â”Œâ”€â”€â”€â”€â”€â–¶â”‚INSTALLED â”‚ (code on disk, not running)
         â”‚   â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚   â”‚           â”‚ start (or auto-start)
         â”‚   â”‚           â–¼
Cloud    â”‚   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Buhdi â”€â”€â”€â”¤   â”‚      â”‚ RUNNING  â”‚â—€â”€â”€â”€ steady state
pushes   â”‚   â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
update   â”‚   â”‚           â”‚
         â”‚   â”‚      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
         â”‚   â”‚      â–¼          â–¼
         â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   â””â”€â”‚UPDATINGâ”‚ â”‚ ERROR  â”‚
         â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                    â”‚ auto-retry (3x) then
         â”‚                    â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ DISABLED â”‚ (needs manual intervention)
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ uninstall
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ REMOVED  â”‚ (cleanup, delete files)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Sandbox Runtime

**Primary: isolated-vm (V8 isolates)**
- True V8 isolate â€” separate heap, no shared memory with host
- CPU time limits enforced at V8 level
- Memory limits enforced at V8 level
- No access to Node.js APIs unless explicitly bridged

**Why not alternatives:**
- VM2: Deprecated, known escapes
- Deno workers: Requires Deno runtime (extra install)
- Docker: Too heavy for small tools, slow startup
- Worker threads: Share memory, not true isolation

**Bridged APIs (available inside sandbox):**

```typescript
// What a plugin sees:
declare const buhdi: {
  // HTTP (only to allowed hosts from permissions.network)
  fetch(url: string, opts?: RequestInit): Promise<Response>;
  
  // Filesystem (scoped to plugin's ./data directory)
  fs: {
    read(path: string): Promise<string>;
    write(path: string, data: string): Promise<void>;
    list(path: string): Promise<string[]>;
    delete(path: string): Promise<void>;
  };
  
  // Vault (secrets manager â€” never in code)
  vault: {
    get(key: string): Promise<string | null>;
    set(key: string, value: string): Promise<void>;
  };
  
  // Config (from manifest.config, set by user or Cloud Buhdi)
  config: Record<string, unknown>;
  
  // Logging (sent to audit trail)
  log: {
    info(msg: string): void;
    warn(msg: string): void;
    error(msg: string): void;
  };
  
  // Report results back to Cloud Buhdi
  report(data: Record<string, unknown>): Promise<void>;
  
  // Schedule a follow-up run
  scheduleNext(delayMs: number): void;
};
```

**What a plugin CANNOT do:**
- âŒ Access Node.js `require()`, `process`, `child_process`
- âŒ Read files outside its own `./data` directory
- âŒ Make network requests to hosts not in its permissions
- âŒ Access other plugins' data
- âŒ Modify the buhdi-node core
- âŒ Access system environment variables (only vault secrets)
- âŒ Spawn processes or execute shell commands
- âŒ Access the filesystem root

### 1.4 Hot Reload

Plugins hot-reload without restarting buhdi-node:

```
1. Cloud Buhdi pushes new code bundle
2. Plugin Manager receives bundle
3. Validates code hash + signature
4. If plugin is RUNNING:
   a. Waits for current execution to complete (or timeout)
   b. Tears down old isolate
   c. Creates new isolate with new code
   d. Starts new isolate
   e. If start fails â†’ rollback to previous version
5. If plugin is not running:
   a. Replaces code on disk
   b. Done (will use new code on next start)
```

Zero downtime. If the new version crashes on startup, automatic rollback.

---

## 2. Deployment Channel

### 2.1 Deploy Protocol

All deploys go over the existing WebSocket connection:

```
Cloud Buhdi                              buhdi-node
    â”‚                                        â”‚
    â”‚â”€â”€â”€â”€ DEPLOY_TOOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚     { manifest, codeBundle,            â”‚
    â”‚       signature, trustAction }         â”‚
    â”‚                                        â”‚
    â”‚     trustAction = "auto" | "pending"   â”‚
    â”‚                                        â”‚
    â”‚                                        â”œâ”€â”€ Verify signature
    â”‚                                        â”œâ”€â”€ Check trust level
    â”‚                                        â”‚
    â”‚â—€â”€â”€â”€ DEPLOY_ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  (if auto-approved)
    â”‚     { status: "installed",             â”‚
    â”‚       toolId, version }                â”‚
    â”‚                                        â”‚
    â”‚   OR                                   â”‚
    â”‚                                        â”‚
    â”‚â—€â”€â”€â”€ DEPLOY_PENDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  (needs user approval)
    â”‚     { toolId, approvalUrl }            â”‚
    â”‚                                        â”‚
    â”‚     ... user approves in dashboard ... â”‚
    â”‚                                        â”‚
    â”‚â—€â”€â”€â”€ DEPLOY_ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚     { status: "installed" }            â”‚
    â”‚                                        â”‚
    â”‚â”€â”€â”€â”€ START_TOOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚     { toolId }                         â”‚
    â”‚                                        â”‚
    â”‚â—€â”€â”€â”€ TOOL_STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚     { toolId, status: "running" }      â”‚
```

### 2.2 Code Signing

Every code bundle is signed by Cloud Buhdi's deployment key:

```
1. Cloud Buhdi generates code
2. SHA-256 hash of the bundle
3. Sign hash with Ed25519 deployment key (per-user keypair)
4. Node verifies signature against known public key
5. If signature fails â†’ reject deploy, alert user
```

This prevents:
- Tampered code in transit
- Rogue deploys from non-Cloud-Buhdi sources
- Replay attacks (nonce included in signature)

### 2.3 Versioning & Rollback

```
plugins/
  square-pos-sync/
    manifest.json          â† current version
    index.js               â† current code
    data/                  â† plugin's persistent data
    versions/
      1.0.0/
        manifest.json
        index.js
      1.1.0/
        manifest.json
        index.js
      1.2.0/               â† current
        manifest.json
        index.js
```

- Last 5 versions kept on disk
- Rollback: `ROLLBACK_TOOL { toolId, version }` command
- Automatic rollback if new version fails health check within 60s
- User can rollback from mybuhdi.com dashboard with one click

### 2.4 Diff-Based Updates

For small changes, Cloud Buhdi sends a diff instead of the full bundle:

```json
{
  "type": "DEPLOY_PATCH",
  "toolId": "square-pos-sync",
  "fromVersion": "1.1.0",
  "toVersion": "1.2.0",
  "patches": [
    { "file": "index.js", "diff": "--- a/index.js\n+++ b/index.js\n@@ -42,3 +42,7 @@..." }
  ],
  "newHash": "sha256:def456...",
  "signature": "..."
}
```

Node applies patch, verifies resulting hash matches. If mismatch â†’ requests full bundle.

---

## 3. Permission Model

### 3.1 Permission Categories

| Category | Examples | Risk Level |
|----------|----------|------------|
| **Network** | Which hosts/ports the plugin can reach | ğŸŸ¡ Medium |
| **Filesystem** | Read/write paths relative to plugin dir | ğŸŸ¢ Low |
| **Vault** | Which secrets the plugin can access | ğŸ”´ High |
| **System** | Shell commands (very restricted) | ğŸ”´ Critical |
| **Schedule** | How often the plugin runs | ğŸŸ¢ Low |
| **Resources** | CPU/memory/disk limits | ğŸŸ¢ Low |

### 3.2 Permission Grant Flow

```
Cloud Buhdi writes new tool that needs Square API access
    â”‚
    â–¼
Manifest includes: permissions.network: ["connect.squareup.com"]
                   permissions.vault: ["SQUARE_ACCESS_TOKEN"]
    â”‚
    â–¼
Trust level check:
    â”‚
    â”œâ”€â”€ ğŸ”’ Approve Each â†’ Show in dashboard:
    â”‚     "Buhdi wants to install 'Square POS Sync'"
    â”‚     "This tool will access: connect.squareup.com"
    â”‚     "This tool needs secret: SQUARE_ACCESS_TOKEN"
    â”‚     [Approve] [Reject] [Ask Buhdi Why]
    â”‚
    â”œâ”€â”€ âœ… Approve New â†’ Same as above (it's a new tool)
    â”‚
    â””â”€â”€ ğŸ¦š Peacock â†’ Auto-approved, logged to audit trail
```

### 3.3 Permission Escalation

If a running tool needs a new permission (Cloud Buhdi updates it):

```
Cloud Buhdi pushes v1.2.0 that now also needs filesystem write
    â”‚
    â–¼
Permission diff detected: +filesystem.write:./data/reports
    â”‚
    â–¼
    â”œâ”€â”€ ğŸ”’ Approve Each â†’ Approval needed (permission change)
    â”œâ”€â”€ âœ… Approve New â†’ Auto-approved (existing tool, just new permission)
    â””â”€â”€ ğŸ¦š Peacock â†’ Auto-approved
```

### 3.4 Guardrails (Non-Negotiable, All Trust Levels)

Even in Peacock mode, these are hard limits:

- âŒ No shell command execution (system permission is reserved for future, gated separately)
- âŒ No access to buhdi-node's own config/credentials
- âŒ No access to other users' data (multi-tenant safety)
- âŒ No cryptocurrency mining detection (CPU pattern analysis)
- âŒ No outbound to known malicious hosts (blocklist)
- âŒ Max 10 plugins per node (prevents resource exhaustion)
- âŒ Max 500MB total plugin disk usage
- âŒ No plugin can run longer than 5 minutes per execution

---

## 4. Tool Development Protocol

### 4.1 How Cloud Buhdi Writes Tools

This is the Ralph Loop adapted for tool development:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Cloud Buhdi Tool Dev Loop               â”‚
â”‚                                                      â”‚
â”‚  1. ANALYZE                                          â”‚
â”‚     â””â”€â”€ What does this business need?                â”‚
â”‚     â””â”€â”€ What data sources exist?                     â”‚
â”‚     â””â”€â”€ What's the simplest tool that helps?         â”‚
â”‚                                                      â”‚
â”‚  2. WRITE                                            â”‚
â”‚     â””â”€â”€ Generate manifest + code                     â”‚
â”‚     â””â”€â”€ Use tool templates for common patterns       â”‚
â”‚     â””â”€â”€ Include error handling + retry logic         â”‚
â”‚                                                      â”‚
â”‚  3. TEST (in cloud sandbox first)                    â”‚
â”‚     â””â”€â”€ Unit tests (also written by Cloud Buhdi)     â”‚
â”‚     â””â”€â”€ Mock the buhdi.* APIs                        â”‚
â”‚     â””â”€â”€ Verify expected outputs                      â”‚
â”‚                                                      â”‚
â”‚  4. AUDIT (Ward reviews the code)                    â”‚
â”‚     â””â”€â”€ Security: no injection, no data leaks        â”‚
â”‚     â””â”€â”€ Performance: no infinite loops, bounded mem  â”‚
â”‚     â””â”€â”€ Correctness: does it match the intent?       â”‚
â”‚                                                      â”‚
â”‚  5. DEPLOY                                           â”‚
â”‚     â””â”€â”€ Sign the bundle                              â”‚
â”‚     â””â”€â”€ Push to node (respecting trust level)        â”‚
â”‚     â””â”€â”€ Monitor first 60s for errors                 â”‚
â”‚                                                      â”‚
â”‚  6. VERIFY                                           â”‚
â”‚     â””â”€â”€ Check tool reports expected data              â”‚
â”‚     â””â”€â”€ If errors â†’ diagnose â†’ go to step 2          â”‚
â”‚     â””â”€â”€ If working â†’ mark as stable                  â”‚
â”‚                                                      â”‚
â”‚  7. ITERATE (ongoing)                                â”‚
â”‚     â””â”€â”€ Monitor tool performance over days            â”‚
â”‚     â””â”€â”€ If edge cases found â†’ write fix â†’ redeploy   â”‚
â”‚     â””â”€â”€ If business needs change â†’ adapt tool         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Tool Templates

Cloud Buhdi starts with templates for common patterns:

| Template | Use Case | Example |
|----------|----------|---------|
| **api-sync** | Poll external API, store results | Square POS, QuickBooks |
| **file-watcher** | Monitor local files for changes | Invoice folder, CSV drops |
| **scheduled-report** | Generate report on schedule | Daily sales summary |
| **webhook-receiver** | Listen for incoming webhooks | Payment notifications |
| **data-transformer** | Convert between formats | CSV â†’ JSON, XML â†’ DB |
| **alert-monitor** | Watch metrics, alert on threshold | Inventory low, CPU high |
| **dashboard-widget** | UI component for local dashboard | Sales chart, task list |

### 4.3 Cloud-Side Testing Sandbox

Before any code touches a user's node, it runs in a cloud sandbox:

```
Cloud Sandbox (Vercel Edge Function or dedicated container)
    â”‚
    â”œâ”€â”€ Mock buhdi.fetch() â†’ recorded HTTP responses
    â”œâ”€â”€ Mock buhdi.fs â†’ in-memory filesystem
    â”œâ”€â”€ Mock buhdi.vault â†’ test secrets
    â”œâ”€â”€ Mock buhdi.config â†’ test config values
    â”‚
    â””â”€â”€ Run tool â†’ capture output â†’ verify correctness
```

If the tool crashes in cloud testing, it never reaches the node.

---

## 5. Local Dashboard Server

### 5.1 Architecture

```
buhdi-node
    â”‚
    â”œâ”€â”€ Plugin Runtime (existing)
    â”‚
    â””â”€â”€ Dashboard Server (:3847)
        â”œâ”€â”€ Static file server (HTML/CSS/JS)
        â”œâ”€â”€ API proxy to plugin data
        â”œâ”€â”€ WebSocket for live updates
        â””â”€â”€ Auth: local-only by default
            OR token-authenticated if exposed
```

### 5.2 How Cloud Buhdi Builds Dashboards

Cloud Buhdi treats dashboards as a special plugin type:

```json
{
  "name": "bakery-dashboard",
  "type": "dashboard",
  "version": "1.0.0",
  "entry": "index.html",
  "dataSources": ["square-pos-sync", "inventory-tracker"],
  "permissions": {
    "network": [],
    "filesystem": ["read:../square-pos-sync/data", "read:../inventory-tracker/data"]
  }
}
```

The dashboard plugin can read other plugins' data directories (with permission). Cloud Buhdi generates:
- React/Preact components (small bundle)
- Tailwind CSS (matches mybuhdi.com design system)
- Real-time updates via plugin report() â†’ dashboard WebSocket

### 5.3 Dashboard Templates

| Template | Components |
|----------|-----------|
| **Retail** | Daily sales, inventory levels, top products, foot traffic |
| **Service** | Appointments today, client follow-ups, revenue tracker |
| **Restaurant** | Orders, kitchen status, waste tracking, supplier costs |
| **Generic** | KPI cards, charts, activity feed, alerts |

Cloud Buhdi customizes templates based on onboarding data.

---

## 6. Audit Trail

### 6.1 What Gets Logged

Every operation is recorded:

```json
{
  "id": "uuid",
  "node_id": "uuid",
  "user_id": "uuid",
  "action": "deploy|start|stop|update|rollback|uninstall|error|permission_grant",
  "tool_id": "square-pos-sync",
  "tool_version": "1.2.0",
  "initiated_by": "cloud-buhdi|user|auto-recovery",
  "reason": "New integration requested during onboarding",
  "details": { ... },
  "timestamp": "2026-03-15T10:00:00Z"
}
```

### 6.2 User-Facing Audit View

In mybuhdi.com dashboard â†’ Node â†’ Activity:

```
ğŸ“¦ Mar 18, 2:30 PM â€” Updated "Square POS Sync" to v1.2.0
   Reason: "Added batch report handling for Tuesday 3pm edge case"
   Initiated by: Cloud Buhdi (auto-update, Peacock mode)

ğŸš€ Mar 15, 10:00 AM â€” Installed "Square POS Sync" v1.0.0
   Reason: "Onboarding: user needs POS integration"
   Approved by: User (manual approval)

âš ï¸ Mar 16, 3:15 PM â€” Error in "Square POS Sync"
   Error: "Square API rate limit hit"
   Auto-action: Reduced sync frequency to every 30 min
```

### 6.3 Rollback from Dashboard

Each deploy entry has a "Rollback" button. One click:
1. Stops current version
2. Restores previous version from `versions/` dir
3. Starts previous version
4. Logs the rollback in audit trail
5. Notifies Cloud Buhdi (so it knows to investigate)

---

## 7. Backend API Changes (mybuhdi.com)

### 7.1 New Database Tables

```sql
-- Tool registry: what tools exist per node
CREATE TABLE node_tools (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  node_id UUID NOT NULL REFERENCES user_nodes(id),
  name TEXT NOT NULL,
  description TEXT,
  version TEXT NOT NULL,
  type TEXT NOT NULL DEFAULT 'plugin',  -- plugin | dashboard
  status TEXT NOT NULL DEFAULT 'pending',  -- pending | installed | running | error | disabled | removed
  manifest JSONB NOT NULL,
  code_hash TEXT NOT NULL,
  permissions_granted JSONB DEFAULT '{}',
  config JSONB DEFAULT '{}',
  error_message TEXT,
  last_run_at TIMESTAMPTZ,
  last_error_at TIMESTAMPTZ,
  install_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(node_id, name)
);

-- Deploy history: audit trail
CREATE TABLE node_tool_deploys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tool_id UUID NOT NULL REFERENCES node_tools(id),
  user_id UUID NOT NULL,
  node_id UUID NOT NULL,
  action TEXT NOT NULL,  -- deploy | update | rollback | uninstall | start | stop | error
  version TEXT,
  initiated_by TEXT NOT NULL,  -- cloud-buhdi | user | auto-recovery
  reason TEXT,
  details JSONB,
  trust_action TEXT,  -- auto | pending | approved | rejected
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Tool execution logs
CREATE TABLE node_tool_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tool_id UUID NOT NULL REFERENCES node_tools(id),
  node_id UUID NOT NULL,
  started_at TIMESTAMPTZ NOT NULL,
  completed_at TIMESTAMPTZ,
  status TEXT NOT NULL,  -- running | success | error | timeout
  duration_ms INTEGER,
  result JSONB,
  error TEXT,
  resource_usage JSONB  -- { memory_mb, cpu_percent, network_bytes }
);
```

### 7.2 New API Endpoints

```
POST   /api/node/:nodeId/tools/deploy     â€” Cloud Buhdi pushes a tool
GET    /api/node/:nodeId/tools             â€” List tools on a node
GET    /api/node/:nodeId/tools/:toolId     â€” Get tool details + recent runs
PATCH  /api/node/:nodeId/tools/:toolId     â€” Update config, start/stop
DELETE /api/node/:nodeId/tools/:toolId     â€” Uninstall tool
POST   /api/node/:nodeId/tools/:toolId/approve  â€” User approves pending tool
POST   /api/node/:nodeId/tools/:toolId/rollback â€” Rollback to previous version
GET    /api/node/:nodeId/tools/:toolId/logs     â€” Get execution logs
GET    /api/node/:nodeId/activity          â€” Full audit trail for node
```

---

## 8. Multi-Node Orchestration (Phase 5)

When a user has multiple nodes, Cloud Buhdi can coordinate across them:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node: Store A   â”‚    â”‚  Node: Store B   â”‚    â”‚  Node: Warehouse â”‚
â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚  square-sync     â”‚    â”‚  square-sync     â”‚    â”‚  inventory-mgr   â”‚
â”‚  inventory-a     â”‚    â”‚  inventory-b     â”‚    â”‚  shipping-track  â”‚
â”‚  foot-traffic    â”‚    â”‚  foot-traffic    â”‚    â”‚  supplier-orders â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                          Cloud Buhdi
                    (orchestrates across all)
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Cross-Node Tools:     â”‚
                    â”‚   - inventory-rebalance  â”‚
                    â”‚   - unified-reporting    â”‚
                    â”‚   - staff-scheduler      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Cross-node tools run in the cloud (not on any single node) and query multiple nodes' data through their `buhdi.report()` outputs.

---

## 9. Self-Optimization (Phase 4)

Cloud Buhdi monitors tool performance and auto-improves:

```
Tool "square-pos-sync" error log:
  - Tue 3:00 PM: timeout (Square batch report running)
  - Tue 3:00 PM: timeout
  - Tue 3:00 PM: timeout
  - Wed: OK
  - Thu: OK
  - Tue 3:00 PM: timeout

Cloud Buhdi detects pattern:
  "square-pos-sync fails every Tuesday at 3 PM"

Cloud Buhdi writes fix:
  "Skip sync window 2:50-3:15 PM on Tuesdays, retry at 3:20"

Deploy loop:
  write fix â†’ test â†’ audit â†’ deploy â†’ verify next Tuesday â†’ confirm fix
```

This happens automatically. The user sees in their audit trail:
> ğŸ”§ Updated "Square POS Sync" to v1.2.0
> Reason: "Detected recurring Tuesday 3 PM timeout â€” added skip window during Square batch processing"

---

## 10. Security Considerations

### 10.1 Non-Negotiable Security Boundaries

| Boundary | Enforcement |
|----------|-------------|
| Plugin isolation | V8 isolates (isolated-vm) â€” no shared memory |
| Network egress | Proxy through node's HTTP client, check allowlist |
| Filesystem scope | chroot-style path resolution, no `../` escape |
| Resource limits | V8 isolate limits + OS-level cgroup (Linux) / Job Object (Windows) |
| Code integrity | Ed25519 signature verification on every deploy |
| Secret protection | Vault API only, never in code, never logged |
| Audit completeness | Every operation logged, immutable append-only |

### 10.2 Ward Audit for Generated Code

Every tool Cloud Buhdi writes goes through Ward before deploy:

```
Cloud Buhdi writes code
    â”‚
    â–¼
Ward reviews for:
    â”œâ”€â”€ Injection vulnerabilities (SQL, command, path traversal)
    â”œâ”€â”€ Data exfiltration patterns (sending user data to unknown hosts)
    â”œâ”€â”€ Resource abuse (infinite loops, fork bombs, memory leaks)
    â”œâ”€â”€ Permission overreach (requesting more than needed)
    â”œâ”€â”€ Credential handling (secrets in code, logging tokens)
    â””â”€â”€ Code quality (error handling, edge cases)
    â”‚
    â–¼
Score: A/B/C
    â”œâ”€â”€ A: Deploy
    â”œâ”€â”€ B: Deploy with note
    â””â”€â”€ C: Rewrite required â†’ back to Cloud Buhdi
```

### 10.3 User Data Boundaries

- Each user's plugins are completely isolated from other users
- Plugin data directories are per-user, per-node, per-plugin
- No plugin can access another plugin's data without explicit cross-plugin permission
- Cloud Buhdi has read access to all of a user's plugins (for optimization) but NOT other users'

---

## 11. Implementation Phases

### Phase A: Plugin Runtime MVP (2-3 weeks)

**Goal:** A plugin can be installed and run on the node.

- [ ] Plugin directory structure (`~/.buhdi-node/plugins/`)
- [ ] Manifest parser and validator
- [ ] isolated-vm sandbox with bridged APIs (`buhdi.fetch`, `buhdi.fs`, `buhdi.log`, `buhdi.report`)
- [ ] Plugin Manager: install, start, stop, uninstall
- [ ] Hot reload (stop old isolate, start new one)
- [ ] WebSocket commands: `DEPLOY_TOOL`, `START_TOOL`, `STOP_TOOL`, `TOOL_STATUS`
- [ ] Basic audit logging (to local file, sync to cloud)

**Deliverable:** Cloud Buhdi can write a simple API polling tool and deploy it to a node.

### Phase B: Trust & Permissions (1-2 weeks)

**Goal:** Users control what gets deployed.

- [ ] `node_tools` table in Supabase
- [ ] Trust level integration (read from user settings)
- [ ] Approval workflow UI in mybuhdi.com dashboard
- [ ] Permission enforcement in sandbox (network allowlist, fs scoping)
- [ ] Code signing (Ed25519 keypair per user)
- [ ] Signature verification on node

**Deliverable:** Non-Peacock users see approval prompts. All deploys are signed and verified.

### Phase C: Vault & Secrets (1 week)

**Goal:** Plugins can securely access credentials.

- [ ] Local vault (encrypted file, key derived from node API key)
- [ ] `buhdi.vault.get/set` API in sandbox
- [ ] Cloud Buhdi can provision secrets via `SET_SECRET` command
- [ ] Secrets never logged, never in code bundles

**Deliverable:** Square POS Sync can use SQUARE_ACCESS_TOKEN without it ever appearing in code.

### Phase D: Dashboard Server (1-2 weeks)

**Goal:** Cloud Buhdi can push custom UIs.

- [ ] Local HTTP server on configurable port
- [ ] Dashboard plugin type (serves HTML/CSS/JS)
- [ ] Cross-plugin data reading (with permission)
- [ ] WebSocket for live updates from plugins
- [ ] Auth for non-local access

**Deliverable:** User opens `localhost:3847` and sees a custom dashboard built by Cloud Buhdi.

### Phase E: Deploy Pipeline & Ward Integration (1 week)

**Goal:** Every tool goes through quality gates before reaching the node.

- [ ] Cloud sandbox for pre-deploy testing
- [ ] Ward audit integration (automatic before every deploy)
- [ ] Quality scoring (A/B/C)
- [ ] Auto-rollback on post-deploy failure
- [ ] `node_tool_deploys` audit trail table
- [ ] Dashboard view: deploy history with rollback buttons

**Deliverable:** No broken tool ever reaches a user's node.

### Phase F: Self-Optimization & Multi-Node (2-3 weeks)

**Goal:** Cloud Buhdi evolves tools and coordinates across nodes.

- [ ] `node_tool_runs` execution log table
- [ ] Pattern detection on error logs
- [ ] Auto-fix generation and deploy
- [ ] Cross-node tool type (runs in cloud, queries multiple nodes)
- [ ] Unified reporting across nodes
- [ ] Fleet dashboard in mybuhdi.com

**Deliverable:** Full Phase 4-5 vision â€” self-healing tools and multi-location orchestration.

### Total Estimated Timeline: 8-12 weeks for full v0.3

MVP (Phases A+B): 3-5 weeks â€” enough to demo "Cloud Buhdi wrote and deployed a custom tool"

---

## 12. Migration from v0.2

v0.3 builds on v0.2's foundation:

- v0.2's service mode â†’ still the host process for plugins
- v0.2's WebSocket connection â†’ carries deploy commands
- v0.2's health check â†’ extended to report plugin status
- v0.2's config file â†’ extended with plugin settings

No breaking changes. v0.2 nodes that upgrade to v0.3 just gain plugin capabilities.

---

## Appendix: Example â€” Bakery Onboarding â†’ Custom Node

```
Day 1: Bakery signs up, talks to Cloud Buhdi
  â†’ Cloud Buhdi learns: Square POS, manual inventory in spreadsheet,
    biggest pain = food waste ($2k/month)

Day 2: Cloud Buhdi deploys to their node:
  â†’ square-pos-sync (polls daily sales)
  â†’ inventory-tracker (reads their shared Google Sheet)
  â†’ waste-analyzer (cross-references sales vs inventory)
  â†’ bakery-dashboard (shows all three in one local UI)

Day 7: Cloud Buhdi notices pattern:
  â†’ Sourdough sells out by noon on weekdays
  â†’ Croissants have 40% waste on Mondays
  â†’ Pushes update: waste-analyzer now flags "make 50% more sourdough,
    30% fewer Monday croissants"

Day 30: Cloud Buhdi adds:
  â†’ supplier-price-tracker (monitors flour/butter prices from emails)
  â†’ auto-reorder (drafts purchase orders when inventory hits threshold)
  â†’ The bakery dashboard now shows cost trends and savings

Day 90: The bakery's node has 8 custom tools, all written by Cloud Buhdi,
  all specific to THIS bakery's patterns. No other bakery has exactly
  this setup. The value of switching away is enormous.
```

---

*This spec defines the product's core differentiator. Everything else is plumbing. This is what makes mybuhdi.com worth paying for.*
