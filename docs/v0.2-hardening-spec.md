# buhdi-node v0.2 â€” Bulletproof Auto-Connect & Service Mode

**Status:** Draft  
**Author:** Buhdi  
**Date:** 2026-02-20  
**Current version:** 0.1.0 â†’ Target: 0.2.0

---

## Executive Summary

v0.1 works but is fragile: no auto-reconnect on token expiry, no crash recovery, requires manual start, API key visible in CLI history. v0.2 makes buhdi-node a production-grade daemon that survives reboots, network blips, and token expiry without user intervention.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User's Machine                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Service Mgr â”‚â”€â”€â”€â–¶â”‚         buhdi-node daemon        â”‚ â”‚
â”‚  â”‚ (systemd /  â”‚    â”‚                                  â”‚ â”‚
â”‚  â”‚  launchd /  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  WinSvc)    â”‚    â”‚  â”‚ Connectionâ”‚  â”‚   Health     â”‚ â”‚ â”‚
â”‚  â”‚             â”‚    â”‚  â”‚   State   â”‚  â”‚   Check      â”‚ â”‚ â”‚
â”‚  â”‚ restart on  â”‚    â”‚  â”‚  Machine  â”‚  â”‚ :9847/health â”‚ â”‚ â”‚
â”‚  â”‚ crash       â”‚    â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚                         â”‚ â”‚
â”‚                     â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                     â”‚  â”‚ WebSocket â”‚  â”‚ HTTP Poll    â”‚ â”‚ â”‚
â”‚                     â”‚  â”‚ (primary) â”‚  â”‚ (fallback)   â”‚ â”‚ â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                     â”‚        â”‚               â”‚         â”‚ â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                       â”‚
                  wss://buhdi-ws.fly.dev   https://mybuhdi.com
                       â”‚                       â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            mybuhdi.com backend             â”‚
              â”‚                                            â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
              â”‚  â”‚ WS Relay â”‚ â”‚ Node APIâ”‚ â”‚ Dashboard  â”‚  â”‚
              â”‚  â”‚ (Fly.io) â”‚ â”‚ /api/   â”‚ â”‚ /settings  â”‚  â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. Connection State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”Œâ”€â”€â”€â”€â”€â”€â–¶â”‚DISCONNECTEDâ”‚â—€â”€â”€â”€â”€ uninstall / stop
           â”‚       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚             â”‚ connect()
           â”‚             â–¼
           â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚       â”‚CONNECTING â”‚â”€â”€â”€â”€ WS attempt
           â”‚       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚             â”‚
           â”‚        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
           â”‚        â”‚         â”‚
           â”‚    success    failure
           â”‚        â”‚         â”‚
           â”‚        â–¼         â–¼
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚CONNECTED â”‚  â”‚RECONNECTING  â”‚
           â”‚  â”‚ (WS)     â”‚  â”‚ (exp backoff)â”‚
           â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚       â”‚            â”‚
           â”‚   ws close     n failures > threshold
           â”‚       â”‚            â”‚
           â”‚       â–¼            â–¼
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚RECONNECT-â”‚  â”‚POLLING   â”‚
           â”‚  â”‚ING       â”‚  â”‚(HTTP 5s) â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚                     â”‚ WS reconnect succeeds
           â”‚                     â–¼
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONNECTED
```

### State transitions

| From | To | Trigger |
|------|----|---------|
| DISCONNECTED | CONNECTING | `connect()` called |
| CONNECTING | CONNECTED | WS `welcome` received |
| CONNECTING | RECONNECTING | WS error/close |
| CONNECTED | RECONNECTING | WS close, ping timeout |
| RECONNECTING | CONNECTED | WS `welcome` received |
| RECONNECTING | POLLING | 5 consecutive WS failures |
| POLLING | CONNECTED | Background WS attempt succeeds |
| * | DISCONNECTED | `stop()` / uninstall |

### Exponential Backoff

```
attempt:  1    2    3    4    5    6    7+
delay:    1s   2s   4s   8s  16s  32s  60s (cap)
jitter:   Â±500ms random added to each
```

Reset to 1s on successful connection.

### Heartbeat / Stale Connection Detection

- Client sends `ping` every **25s** over WS
- If no `pong` received within **10s**, connection is stale â†’ close + reconnect
- Server sends `ping` every **30s**; client responds with `pong`
- HTTP heartbeat to `/api/node/heartbeat` every **30s** regardless of WS state

---

## 2. Service Mode

### 2.1 Commands

```bash
buhdi-node install          # Install as OS service + start
buhdi-node uninstall        # Stop + remove OS service
buhdi-node start            # Start service (if installed)
buhdi-node stop             # Stop service
buhdi-node restart          # Restart service
buhdi-node setup <API_KEY>  # Save API key to config, register node
buhdi-node status           # Show connection state, uptime, last seen
buhdi-node logs             # Tail recent logs
buhdi-node connect <KEY>    # Interactive mode (no service, foreground)
```

### 2.2 Windows â€” Windows Service

**Library:** `node-windows` (or `winser`)

```
Install:
  1. buhdi-node setup <API_KEY>        â†’ saves to %USERPROFILE%\.buhdi-node\config.json
  2. buhdi-node install                â†’ creates Windows Service "BuhdiNode"
     - Uses node-windows to register dist/index.js as service
     - Service runs as current user (inherits permissions)
     - Auto-start on boot: Yes
     - Recovery: restart after 5s, 30s, 60s (3 attempts)

Uninstall:
  1. buhdi-node uninstall              â†’ stops + removes service

Logs:
  - Written to %USERPROFILE%\.buhdi-node\logs\
  - Windows Event Log as backup
```

### 2.3 macOS â€” launchd Agent

```xml
<!-- ~/Library/LaunchAgents/com.mybuhdi.node.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" ...>
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.mybuhdi.node</string>
  <key>ProgramArguments</key>
  <array>
    <string>/usr/local/bin/node</string>
    <string>/usr/local/lib/node_modules/buhdi-node/dist/index.js</string>
    <string>daemon</string>
  </array>
  <key>RunAtLoad</key><true/>
  <key>KeepAlive</key><true/>
  <key>ThrottleInterval</key><integer>10</integer>
  <key>StandardOutPath</key>
  <string>~/.buhdi-node/logs/stdout.log</string>
  <key>StandardErrorPath</key>
  <string>~/.buhdi-node/logs/stderr.log</string>
</dict>
</plist>
```

```
Install:  cp plist â†’ ~/Library/LaunchAgents/ && launchctl load ...
Uninstall: launchctl unload ... && rm plist
```

### 2.4 Linux â€” systemd User Service

```ini
# ~/.config/systemd/user/buhdi-node.service
[Unit]
Description=Buhdi Node Agent
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/usr/bin/node /usr/lib/node_modules/buhdi-node/dist/index.js daemon
Restart=on-failure
RestartSec=5
StartLimitIntervalSec=300
StartLimitBurst=10
Environment=NODE_ENV=production

[Install]
WantedBy=default.target
```

```bash
Install:  systemctl --user enable --now buhdi-node
Uninstall: systemctl --user disable --now buhdi-node && rm unit file
```

---

## 3. Config File Schema

**Location:** `~/.buhdi-node/config.json` (permissions: `0600`, dir: `0700`)

```jsonc
{
  // v0.2 schema
  "version": 2,

  // Encrypted with DPAPI (Windows) / Keychain (macOS) / libsecret (Linux)
  // Falls back to AES-256-GCM with machine-derived key if native unavailable
  "apiKey_encrypted": "base64...",

  // Node identity (assigned by server on first connect)
  "nodeId": "nd_abc123",
  "nodeName": "Kriz-Desktop",

  // Connection tuning
  "wsUrl": "wss://buhdi-ws.fly.dev/ws",
  "apiUrl": "https://www.mybuhdi.com",

  // Logging
  "logLevel": "info",           // debug | info | warn | error
  "logMaxFiles": 7,             // rotate daily, keep 7 days
  "logMaxSizeMb": 10,           // max per file

  // Health check
  "healthPort": 9847,           // 0 = disabled

  // Feature flags
  "enablePollingFallback": true,
  "enableVault": true
}
```

### API Key Encryption Strategy

| Platform | Method | Key derivation |
|----------|--------|----------------|
| Windows | DPAPI (`crypt32.dll`) | Machine + user context |
| macOS | Keychain Services (via `keytar`) | System keychain |
| Linux | libsecret / GNOME Keyring (via `keytar`) | User session |
| Fallback | AES-256-GCM | PBKDF2 from machine-id + username + salt |

**Library:** `keytar` (Electron's credential store, works standalone)

**Migration:** On first v0.2 run, detect plaintext `apiKey`, encrypt it, write `apiKey_encrypted`, delete `apiKey`.

---

## 4. Crash Recovery

### Uncaught Exception Handler

```typescript
process.on('uncaughtException', (err) => {
  logger.fatal('Uncaught exception â€” exiting for service restart', { error: err.message, stack: err.stack });
  // Flush logs
  // Close WS gracefully
  process.exit(1);  // Let service manager restart us
});

process.on('unhandledRejection', (reason) => {
  logger.error('Unhandled rejection', { reason });
  // Don't exit â€” log and continue unless repeated
});
```

### Restart Throttling

Service managers handle this natively:
- **systemd:** `StartLimitBurst=10` in 300s â†’ stops trying
- **launchd:** `ThrottleInterval=10` â†’ min 10s between restarts
- **Windows:** Recovery tab: restart after 5s/30s/60s, reset after 1 day

### Health Check Endpoint

```
GET http://localhost:9847/health

200 OK:
{
  "status": "healthy",
  "version": "0.2.0",
  "uptime": 3600,
  "connection": "connected",    // state machine value
  "nodeId": "nd_abc123",
  "lastTaskAt": "2026-02-20T19:00:00Z",
  "wsConnected": true
}

503:
{ "status": "unhealthy", "connection": "reconnecting", ... }
```

Implemented with Node's built-in `http.createServer` â€” no Express needed.

---

## 5. Log Rotation

**Library:** `winston` + `winston-daily-rotate-file`

```
~/.buhdi-node/logs/
  buhdi-node-2026-02-20.log
  buhdi-node-2026-02-19.log
  ...
  buhdi-node-2026-02-14.log   (7 day max, auto-deleted)
```

- Max 10MB per file, rotate on date or size
- Console output in interactive mode, file-only in daemon mode
- Structured JSON logs for machine parsing
- Reconnect events logged at `warn` level (not `info`) to reduce spam

---

## 6. Token Refresh

### Current Problem
API key is static â€” no JWT/token expiry. But the WS server auth could start using short-lived tokens.

### v0.2 Approach
1. On connect, server returns `{ token, expiresAt }` in the `welcome` message
2. Node schedules refresh at `expiresAt - 5min`
3. Refresh: `POST /api/node/token/refresh` with current API key â†’ new token
4. If refresh fails, fall back to full re-auth with API key
5. Token stored in memory only (not persisted â€” API key is the persistent credential)

```
Timeline:
  t=0       connect, get token (expires t+60m)
  t=55m     refresh â†’ new token (expires t+120m)
  t=115m    refresh â†’ new token
  ...
```

---

## 7. One-Click Install from Dashboard

### Dashboard UI (`mybuhdi.com/settings/node`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ–¥ï¸ Buhdi Node                                  â”‚
â”‚                                                  â”‚
â”‚  Run tasks on your computer from Cloud Buhdi.    â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 1: Install                             â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚   npm install -g buhdi-node                 â”‚ â”‚
â”‚  â”‚                               [Copy]        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 2: Setup (your key is pre-filled)      â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚   buhdi-node setup bm_live_xxxxx            â”‚ â”‚
â”‚  â”‚                               [Copy]        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 3: Start as service                    â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚   buhdi-node install                        â”‚ â”‚
â”‚  â”‚                               [Copy]        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â”‚  â”€â”€ Your Nodes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                  â”‚
â”‚  ğŸŸ¢ Kriz-Desktop    Windows 11   last: 2s ago   â”‚
â”‚  ğŸ”´ Macbook-Pro     macOS 15     last: 3d ago   â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Platform detection via `navigator.userAgent` â†’ show OS-appropriate instructions (PowerShell for Windows, brew option for macOS, etc.).

---

## 8. Backend API Changes

### New Endpoints

| Method | Path | Purpose |
|--------|------|---------|
| POST | `/api/node/token/refresh` | Refresh short-lived WS token |
| GET | `/api/node/status` | Dashboard: list user's nodes with status |
| DELETE | `/api/node/:id` | Remove a node |

### Modified Endpoints

| Endpoint | Change |
|----------|--------|
| `POST /api/node/connect` | Return `{ token, expiresAt }` in response |
| WS `welcome` msg | Include `{ token, expiresAt }` |

### Database Changes

```sql
ALTER TABLE buhdi_nodes ADD COLUMN IF NOT EXISTS
  last_seen_at TIMESTAMPTZ DEFAULT now();

ALTER TABLE buhdi_nodes ADD COLUMN IF NOT EXISTS
  version VARCHAR(20);

ALTER TABLE buhdi_nodes ADD COLUMN IF NOT EXISTS
  connection_type VARCHAR(10) DEFAULT 'ws';  -- 'ws' | 'poll'
```

---

## 9. Security Considerations

### Threat Model

| Threat | Mitigation |
|--------|-----------|
| API key in CLI history | `setup` command; key encrypted in config file |
| API key in process list | Read from config, not args |
| Config file readable by others | `0600` permissions, validated on startup |
| WS impersonation | TLS (wss://); future: mutual TLS or challenge-response |
| Replay attacks | Token expiry + refresh; nonce on WS auth (future) |
| Local privilege escalation | Service runs as user, not root/SYSTEM |
| Disk fill via logs | Log rotation with size + age limits |
| Malicious task execution | Existing approval system; sandbox dangerous ops |

### v0.2 Security Additions
1. **Encrypted API key storage** (keytar / DPAPI / Keychain)
2. **Config file permission check** on every startup â€” warn + fix if too open
3. **Node fingerprint**: hash of `machine-id + nodeId` sent with each request to detect impersonation
4. **Rate limiting**: max 10 reconnect attempts per minute (prevent accidental DDoS)

---

## 10. New Dependencies

```jsonc
{
  "dependencies": {
    "ws": "^8.16.0",            // existing
    "keytar": "^7.9.0",         // credential encryption
    "winston": "^3.11.0",       // structured logging
    "winston-daily-rotate-file": "^5.0.0"  // log rotation
  },
  "optionalDependencies": {
    "node-windows": "^1.0.0"    // Windows service (only needed on Windows)
  }
}
```

`node-windows`, `launchd` plist generation, and `systemd` unit generation are handled by buhdi-node itself (template strings) â€” no library needed for the latter two.

---

## 11. Implementation Phases

### Phase 1: Config & Logging (2-3 days)
- [ ] Config v2 schema with encrypted API key
- [ ] `keytar` integration (with AES fallback)
- [ ] `buhdi-node setup <KEY>` command
- [ ] Winston logging with rotation
- [ ] `buhdi-node daemon` mode (no console, file logs only)
- [ ] Health check endpoint

### Phase 2: Connection Hardening (2-3 days)
- [ ] Connection state machine (enum + typed transitions)
- [ ] Ping/pong stale detection (25s ping, 10s timeout)
- [ ] Token refresh on `welcome` response
- [ ] Scheduled pre-expiry refresh
- [ ] Polling fallback threshold (5 WS failures â†’ poll)
- [ ] Background WS reconnect while polling

### Phase 3: Service Mode (3-4 days)
- [ ] Windows service via `node-windows`
- [ ] macOS launchd plist generation + install/uninstall
- [ ] Linux systemd unit generation + install/uninstall
- [ ] `buhdi-node install/uninstall/start/stop/restart` commands
- [ ] Crash recovery testing on all 3 platforms

### Phase 4: Dashboard & Backend (2-3 days)
- [ ] `POST /api/node/token/refresh` endpoint
- [ ] `GET /api/node/status` endpoint
- [ ] Dashboard UI: install instructions + node list
- [ ] Platform detection for install instructions
- [ ] DB migration for `last_seen_at`, `version`, `connection_type`

### Phase 5: Testing & Polish (1-2 days)
- [ ] Network interruption tests (disconnect Wi-Fi, resume)
- [ ] Token expiry simulation
- [ ] Service crash + restart verification
- [ ] Log rotation verification (fill to 10MB)
- [ ] Security audit (Ward)

**Total estimate: 10-15 days**

---

## 12. Migration Path (v0.1 â†’ v0.2)

1. User runs `npm update -g buhdi-node`
2. On first run, v0.2 detects v1 config (plaintext `apiKey`)
3. Encrypts key â†’ writes `apiKey_encrypted` â†’ deletes `apiKey`
4. Prompts: "Run `buhdi-node install` to enable auto-start"
5. Existing `buhdi-node connect <KEY>` still works (interactive mode)

---

## Appendix: File Structure (v0.2)

```
buhdi-node/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts           # CLI entry point + command routing
â”‚   â”œâ”€â”€ daemon.ts          # Daemon mode (no TTY, file logging)
â”‚   â”œâ”€â”€ config.ts          # Config load/save/encrypt/migrate
â”‚   â”œâ”€â”€ connection.ts      # State machine + WS + polling
â”‚   â”œâ”€â”€ executor.ts        # Task execution (unchanged)
â”‚   â”œâ”€â”€ health.ts          # HTTP health check server
â”‚   â”œâ”€â”€ logger.ts          # Winston setup + rotation
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ install.ts     # Platform detection + install router
â”‚   â”‚   â”œâ”€â”€ windows.ts     # node-windows integration
â”‚   â”‚   â”œâ”€â”€ macos.ts       # launchd plist generation
â”‚   â”‚   â””â”€â”€ linux.ts       # systemd unit generation
â”‚   â”œâ”€â”€ handshake.ts       # System detection (unchanged)
â”‚   â”œâ”€â”€ tools.ts           # Tool scanning (unchanged)
â”‚   â””â”€â”€ vault.ts           # Vault keypair (unchanged)
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ v0.2-hardening-spec.md  â† this file
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```
